name: Mobile App Security Scan (MobSF Multi)

on:
  workflow_dispatch:
    inputs:
      apk_input:
        description: "APK URLs or Package Identifiers (comma, space, or newline separated)"
        required: true
        type: string

jobs:
  mobsf-multi:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repo
      uses: actions/checkout@v4

    - name: Install Dependencies
      run: |
        sudo apt update
        sudo apt install -y python3 python3-pip curl jq unzip
        cargo --version || sudo apt install -y cargo
        cargo install apkeep

    # -----------------------------------------------------------
    # STEP 1 — Parse input list (comma, semicolon, space, newline)
    # -----------------------------------------------------------
    - name: Normalize Input Into a List
      id: parse
      run: |
        RAW="${{ github.event.inputs.apk_input }}"

        echo "$RAW" \
          | tr ',;，、' '\n' \
          | tr ' ' '\n' \
          | sed 's/^[ \t]*//;s/[ \t]*$//' \
          | sed '/^$/d' \
          > apk_list.txt

        echo "Parsed APK Targets:"
        cat apk_list.txt

    # -----------------------------------------------------------
    # STEP 2 — Download ALL APKs (supports URLs + apkeep)
    # -----------------------------------------------------------
    - name: Download all APKs (URL or apkeep)
      id: fetch
      run: |
        mkdir -p apk
        mkdir -p downloaded
        mkdir -p failed
        > downloaded/list.txt
        > failed/list.txt

        n=0
        while IFS= read -r APK; do
          n=$((n+1))
          echo "==============================="
          echo "Downloading target $n:"
          echo "$APK"
          echo "==============================="

          mkdir -p "apk/$n"

          # --- URL Handling ------------------------------------
          if [[ "$APK" =~ ^https?:// ]]; then
            echo "Detected direct URL → using curl"

            OUT="apk/$n/app_$n.apk"

            # Follow redirects & fail on errors
            if curl -L --fail -o "$OUT" "$APK"; then
              echo "$APK:$OUT" >> downloaded/list.txt
              echo "✔ Downloaded via URL: $OUT"
            else
              echo "❌ Download failed (URL): $APK"
              echo "$APK" >> failed/list.txt
            fi

            continue
          fi

          # --- PACKAGED ID (apkeep) -----------------------------
          echo "Using apkeep for package: $APK"
          apkeep -a "$APK" "apk/$n" -o 'arch=arm64-v8a' || true

          FILE=$(ls "apk/$n"/*.apk 2>/dev/null || true)

          if [[ -z "$FILE" ]]; then
            echo "❌ apkeep failed: $APK"
            echo "$APK" >> failed/list.txt
            continue
          fi

          echo "$APK:$FILE" >> downloaded/list.txt
          echo "✔ apkeep downloaded: $FILE"

        done < apk_list.txt

        echo "done=true" >> $GITHUB_OUTPUT

    # -----------------------------------------------------------
    # STEP 3 — Start MobSF container AFTER download stage
    # -----------------------------------------------------------
    - name: Start MobSF Container
      if: steps.fetch.outputs.done == 'true'
      run: |
        docker pull opensecurity/mobile-security-framework-mobsf:latest
        docker run -d -p 8000:8000 --name mobsf \
          opensecurity/mobile-security-framework-mobsf:latest
        sleep 40

    # -----------------------------------------------------------
    # STEP 4 — Scan only successfully downloaded APKs
    # -----------------------------------------------------------
    - name: Scan APKs with MobSF
      id: scan
      run: |
        mkdir -p results
        i=0

        while IFS= read -r ENTRY; do
          i=$((i+1))

          APK=$(echo "$ENTRY" | cut -d':' -f1)
          FILE=$(echo "$ENTRY" | cut -d':' -f2)

          echo "==============================="
          echo "Scanning $i: $APK"
          echo "==============================="

          # Upload
          UPLOAD=$(curl -s -F "file=@$FILE" http://localhost:8000/api/v1/upload \
            -H "Authorization: mobsf")
          HASH=$(echo "$UPLOAD" | jq -r '.hash')

          if [[ -z "$HASH" || "$HASH" == "null" ]]; then
            echo "❌ MobSF upload failed: $APK"
            continue
          fi

          # Scan
          curl -s -X POST http://localhost:8000/api/v1/scan \
            -H "Authorization: mobsf" \
            -H "Content-Type: application/json" \
            -d "{\"scan_type\":\"apk\",\"file_name\":\"$(basename "$FILE")\",\"hash\":\"$HASH\"}"

          # Download Reports
          SAFE_NAME=$(echo "$APK" | tr '/:?&=' '_' | tr -d '"')

          curl -o "results/${i}_${SAFE_NAME}.pdf" \
            http://localhost:8000/api/v1/download_pdf \
            -H "Authorization: mobsf" \
            -H "Content-Type: application/json" \
            -d "{\"hash\":\"$HASH\"}"

          curl -o "results/${i}_${SAFE_NAME}.json" \
            http://localhost:8000/api/v1/download_json \
            -H "Authorization: mobsf" \
            -H "Content-Type: application/json" \
            -d "{\"hash\":\"$HASH\"}"

          echo "✔ Finished: $APK"
        done < downloaded/list.txt

        echo "total=$i" >> $GITHUB_OUTPUT

    # -----------------------------------------------------------
    # STEP 5 — Send ALL reports via Telegram
    # -----------------------------------------------------------
    - name: Send reports to Telegram
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        for file in results/*; do
          curl -F chat_id="$TELEGRAM_CHAT_ID" \
               -F document=@"$file" \
               https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendDocument
        done

    # -----------------------------------------------------------
    # OPTIONAL — Print failed APK list
    # -----------------------------------------------------------
    - name: Show failed APK downloads
      run: |
        echo "====================================="
        echo "APK DOWNLOADS THAT FAILED:"
        echo "====================================="
        cat failed/list.txt || true
